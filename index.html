<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mini Proyecto Abarrotes</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.datatables.net/2.0.8/css/dataTables.dataTables.css">
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11.12.2/dist/sweetalert2.min.css" rel="stylesheet">
    <link rel="stylesheet" href="./styles.css">
</head>
<body>
    <h1 class="container">Mini Proyecto Abarrotes</h1>
    <div class="container">
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="clients-tab" data-bs-toggle="tab" data-bs-target="#clients-tab-pane" type="button"
                    role="tab" aria-controls="clients-tab-pane" aria-selected="true">Clientes</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="products-tab" data-bs-toggle="tab" data-bs-target="#products-tab-pane" type="button"
                    role="tab" aria-controls="products-tab-pane" aria-selected="false">Productos</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="sales-tab" data-bs-toggle="tab" data-bs-target="#sales-tab-pane" type="button"
                    role="tab" aria-controls="sales-tab-pane" aria-selected="false">Ventas</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="reports-tab" data-bs-toggle="tab" data-bs-target="#reports-tab-pane"
                    type="button" role="tab" aria-controls="reports-tab-pane" aria-selected="false">Reportes</button>
            </li>
        </ul>
        <div class="tab-content" id="myTabContent">
            <div class="tab-pane fade show active" id="clients-tab-pane" role="tabpanel" aria-labelledby="clients-tab" tabindex="0">
                <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#createClientModal">Añadir nuevo cliente</button>
                <table id="clients_table" class="display" style="width:100%">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nombre</th>
                            <th>Apellido</th>
                            <th>Email</th>
                            <th>Telefono</th>
                            <th>Direccion</th>
                            <th>Colonia</th>
                            <th>Ciudad</th>
                            <th>Estado</th>
                            <th>CP</th>
                        </tr>
                    </thead>
                    <tfoot>
                        <tr>
                            <th>ID</th>
                            <th>Nombre</th>
                            <th>Apellido</th>
                            <th>Email</th>
                            <th>Telefono</th>
                            <th>Direccion</th>
                            <th>Colonia</th>
                            <th>Ciudad</th>
                            <th>Estado</th>
                            <th>CP</th>
                        </tr>
                    </tfoot>
                </table>
            </div>
            <div class="tab-pane fade" id="products-tab-pane" role="tabpanel" aria-labelledby="products-tab" tabindex="0">
                <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#createProductModal" >Añadir nuevo producto</button>
                <table id="products_table" class="display" style="width:100%">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nombre</th>
                            <th>SKU</th>
                            <th>Descripción</th>
                            <th>Precio</th>
                        </tr>
                    </thead>
                    <tfoot>
                        <tr>
                            <th>ID</th>
                            <th>Nombre</th>
                            <th>SKU</th>
                            <th>Descripción</th>
                            <th>Precio</th>
                        </tr>
                    </tfoot>
                </table>
            </div>
            <div class="tab-pane fade" id="sales-tab-pane" role="tabpanel" aria-labelledby="sales-tab" tabindex="0">
                <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#createSaleModal">Registrar nueva venta</button>

            </div>
            <div class="tab-pane fade" id="reports-tab-pane" role="tabpanel" aria-labelledby="reports-tab" tabindex="0">...
            </div>
        </div>
        
    </div>


    <!-- Modal -->
    <div class="modal fade" id="editClientModal" tabindex="-1" aria-labelledby="editClientModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="editClientModalLabel">Modal title</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    ...
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary">Save changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="createClientModal" tabindex="-1" aria-labelledby="createClientModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="createClientModalLabel">Nuevo cliente</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form class="row g-3" id="create_client_form">
                        <div class="col-md-6">
                            <label for="input_name" class="form-label">Nombre</label>
                            <input type="text" name="first_name" class="form-control" id="input_name">
                        </div>
                        <div class="col-md-6">
                            <label for="input_lastname" class="form-label">Apellido</label>
                            <input type="text" name="last_name" class="form-control" id="input_lastname">
                        </div>
                        <div class="col-md-6">
                            <label for="inputEmail" class="form-label">Email</label>
                            <input type="email" name="email" class="form-control" id="inputEmail">
                        </div>
                        <div class="col-md-6">
                            <label for="inputPhone" class="form-label">Telefono</label>
                            <input type="text" name="phone" class="form-control" id="inputPhone">
                        </div>
                        <div class="col-6">
                            <label for="inputAddress" class="form-label">Direccion</label>
                            <input type="text" name="address" class="form-control" id="inputAddress" placeholder="1234 Main St">
                        </div>
                        <div class="col-6">
                            <label for="inputAddress2" class="form-label">Colonia</label>
                            <input type="text" name="area" class="form-control" id="inputAddress2" placeholder="Zona Centro">
                        </div>
                        <div class="col-md-6">
                            <label for="inputCity" class="form-label">Ciudad</label>
                            <input type="text" name="city" class="form-control" id="inputCity">
                        </div>
                        <div class="col-md-4">
                            <label for="inputState" class="form-label">Estado</label>
                            <select id="inputState" name="state" class="form-select">
                                <option selected>Selecciona una opcion</option>
                                <option value="Aguascalientes">Aguascalientes</option>
                                <option value="Baja California">Baja California</option>
                                <option value="Baja California Sur">Baja California Sur</option>
                                <option value="Chiapas">Chiapas</option>
                                <option value="Chihuahua">Chihuahua</option>
                                <option value="Ciudad de México">Ciudad de México</option>
                                <option value="Coahuila">Coahuila</option>
                                <option value="Colima">Colima</option>
                                <option value="Durango">Durango</option>
                                <option value="Estado de México">Estado de México</option>
                                <option value="Guanajuato">Guanajuato</option>
                                <option value="Guerrero">Guerrero</option>
                                <option value="Hidalgo">Hidalgo</option>
                                <option value="Jalisco">Jalisco</option>
                                <option value="Michoacan">Michoacán</option>
                                <option value="Morelos">Morelos</option>
                                <option value="Nayarit">Nayarit</option>
                                <option value="Nuevo Leon">Nuevo León</option>
                                <option value="Oaxaca">Oaxaca</option>
                                <option value="Puebla">Puebla</option>
                                <option value="Querétaro">Querétaro</option>
                                <option value="Quintana Roo">Quintana Roo</option>
                                <option value="San Luis Potosí">San Luis Potosí</option>
                                <option value="Sinaloa">Sinaloa</option>
                                <option value="Sonora">Sonora</option>
                                <option value="Tabasco">Tabasco</option>
                                <option value="Tamaulipas">Tamaulipas</option>
                                <option value="Tlaxcala">Tlaxcala</option>
                                <option value="Veracruz">Veracruz</option>
                                <option value="Yucatán">Yucatán</option>
                                <option value="Zacatecas">Zacatecas</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="inputZip" class="form-label">Codigo Postal</label>
                            <input type="text" name="postal_code" class="form-control" id="inputZip">
                        </div>
                        <div class="col-12">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                            <button type="submit" class="btn btn-primary">Crear</button>
                        </div>
                    </form>
                </div>
                
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="editProductModal" tabindex="-1" aria-labelledby="editProductModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="editProductModalLabel">Editar Producto</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form class="row g-3" id="edit_product_form">
                        <div class="col-md-6">
                            <label for="inputName" class="form-label">Nombre</label>
                            <input type="text" name="name" class="form-control" id="inputName">
                        </div>
                        <div class="col-md-6">
                            <label for="inputSKU" class="form-label">SKU</label>
                            <input type="text" name="sku" class="form-control" id="inputSKU">
                        </div>
                        <div class="col-md-12">
                            <label for="inputDescrProduct" class="form-label">Descripcion</label>
                            <textarea type="text" name="descr" class="form-control" id="inputDescrProduct"></textarea>
                        </div>
                        <div class="col-md-6">
                            <label for="inputPrice" class="form-label">Precio</label>
                            <input type="number" name="price" class="form-control" id="inputPrice">
                        </div>
                        <div class="col-12">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                            <button type="submit" class="btn btn-primary">Crear</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="createProductModal" tabindex="-1" aria-labelledby="createProductModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="createProductModalLabel">Nuevo Producto</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form class="row g-3" id="create_product_form">
                        <div class="col-md-6">
                            <label for="inputName" class="form-label">Nombre</label>
                            <input type="text" name="name" class="form-control" id="inputName">
                        </div>
                        <div class="col-md-6">
                            <label for="inputSKU" class="form-label">SKU</label>
                            <input type="text" name="sku" class="form-control" id="inputSKU">
                        </div>
                        <div class="col-md-12">
                            <label for="inputDescrProduct" class="form-label">Descripcion</label>
                            <textarea type="text" name="descr" class="form-control" id="inputDescrProduct"></textarea>
                        </div>
                        <div class="col-md-6">
                            <label for="inputPrice" class="form-label">Precio</label>
                            <input type="number" name="price" class="form-control" id="inputPrice">
                        </div>
                        <div class="col-12">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                            <button type="submit" class="btn btn-primary">Crear</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="createSaleModal" tabindex="-1" aria-labelledby="createSaleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="createSaleModalLabel">Registrar venta</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form class="row g-3" id="create_sale_form">
                        <div class="col-md-12">
                            <label for="inputName" class="form-label">Cliente</label>
                            <select id="clientsSelect" name="client_id" class="form-select"><option value="">Selecciona un cliente</option></select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Producto</label>
                            <select id="productsSelect" name="product_id" class="form-select"><option value="">Selecciona un producto</option></select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Cantidad</label>
                            <input type="number" name="quantity" class="form-control" id="inputPrice">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Precio</label>
                            <input type="number" name="price" class="form-control" id="inputPrice" disabled>
                        </div>
                        <div class="col-12 sale-buttons-container">
                            <button type="button" id="addProductFields" class="btn btn-success">Agregar otro producto a la venta</button>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                            <button type="submit" class="btn btn-primary">Registrar venta</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
   
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.2/moment.min.js"></script>
    <script src="https://cdn.datatables.net/2.0.8/js/dataTables.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script>
        new DataTable('#clients_table', {
            ajax: {
                url:'http://localhost:8000/api/clients',
                dataSrc: 'clients'
            },
            columns: [
                { data: 'client_id' },
                { data: 'first_name' },
                { data: 'last_name' },
                { data: 'email' },
                { data: 'phone' },
                { data: 'address' },
                { data: 'area' },
                { data: 'city' },
                { data: 'state' },
                { data: 'postal_code' },
                {
                    render: function (data, type, row) {
                        return '<button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#editClientModal" data-bs-client-id="' + row.client_id + '">Editar</button>';
                    }
                }
            ],
        });

        new DataTable('#products_table', {
            ajax: {
                url: 'http://localhost:8000/api/products',
                dataSrc: 'products'
            },
            columns: [
                { data: 'product_id' },
                { data: 'name' },
                { data: 'sku' },
                {
                    data: 'descr',
                    render: function (data, type, row) {
                        return '<div><p class="truncated">' + data + '</p></div>';
                    }
                },
                { data: 'price' },
                {
                    render: function (data, type, row) {
                        return '<button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#editProductModal" data-client-id="' + row.client_id + '">Editar</button>';
                    }
                }
            ],
        });
    </script>

    <script>
        document.getElementById('create_client_form').addEventListener('submit', (event) => {
            event.preventDefault();
            const formData = new FormData(create_client_form);
            const data = Object.fromEntries(formData.entries());
            fetch('http://localhost:8000/api/clients', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            }).then(response => response.json())
            .then(data => {
                if (!data.error) {
                    console.log('Success:', data);
                    Swal.fire({
                        icon: "success",
                        title: "Cliente creado!",
                        text: "El cliente fue creado satisfactoriamente",
                    }).then((result) => {
                        if (result.isConfirmed) {
                            $('#createClientModal').modal('hide');
                        }
                    });
                }
                else{
                    throw new Error();
                }
            })
            .catch((error) => {
                console.error('Error:', error);
                Swal.fire({
                    icon: "error",
                    title: "Oops...",
                    text: "Ocurrio un error"
                });
            });
        });

        document.getElementById('create_product_form').addEventListener('submit', (event) => {
                event.preventDefault();
                const formData = new FormData(create_product_form);
                const data = Object.fromEntries(formData.entries());
                fetch('http://localhost:8000/api/products', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                }).then(response => response.json())
                    .then(data => {
                        if (!data.error) {
                            console.log('Success:', data);
                            Swal.fire({
                                icon: "success",
                                title: "Producto creado!",
                                text: "El producto fue creado satisfactoriamente",
                            }).then((result) => {
                                if (result.isConfirmed) {
                                    $('#createProductModal').modal('hide');
                                }
                            });
                        }
                        else {
                            throw new Error();
                        }
                    })
                    .catch((error) => {
                        console.error('Error:', error);
                        Swal.fire({
                            icon: "error",
                            title: "Oops...",
                            text: "Ocurrio un error"
                        });
                    });
            });
    </script>

    <script>
        // Function to populate the select element
        function populateClientsSelect() {
            const selectElement = document.getElementById('clientsSelect');

            // Replace the URL with the API endpoint you are using
            fetch('http://localhost:8000/api/clients')
                .then(response => response.json())
                .then(data => {
                    // Assuming the data is an array of objects with 'id' and 'name' properties
                    data.clients.forEach(item => {
                        const option = document.createElement('option');
                        option.value = item.client_id;
                        option.text = item.first_name+' '+item.last_name;
                        selectElement.appendChild(option);
                    });
                })
                .catch(error => console.error('Error fetching data:', error));
        }

        function populateProductsSelect() {
            const selectElement = document.getElementById('productsSelect');

            // Replace the URL with the API endpoint you are using
            fetch('http://localhost:8000/api/products')
                .then(response => response.json())
                .then(data => {
                    // Assuming the data is an array of objects with 'id' and 'name' properties
                    data.products.forEach(item => {
                        const option = document.createElement('option');
                        option.value = item.product_id;
                        option.text = item.name;
                        selectElement.appendChild(option);
                    });
                })
                .catch(error => console.error('Error fetching data:', error));
        }
        // Call the function to populate the select element
        document.addEventListener('DOMContentLoaded', populateClientsSelect);
        document.addEventListener('DOMContentLoaded', populateProductsSelect);
    </script>

    <script>
        document.getElementById('addProductFields').addEventListener('click', function (event) {
            event.preventDefault();
            let newProductSelect = $("#productsSelect").clone();
            let productElement1 = document.createElement('div');
            let productElement2 = document.createElement('div');
            let productElement3 = document.createElement('div');
            productElement1.innerHTML = `
                <label class="form-label">Producto</label>
                ${newProductSelect[0].outerHTML}
            `;
            productElement2.innerHTML = `
                <label class="form-label">Cantidad</label>
                <input type="number" name="quantity" class="form-control" id="inputPrice">
            `;
            productElement3.innerHTML = `
                <label class="form-label">Precio</label>
                <input type="number" name="price" class="form-control" id="inputPrice" disabled>
            `;
            productElement1.classList.add('col-md-6');
            productElement2.classList.add('col-md-3');
            productElement3.classList.add('col-md-3');
            document.querySelector('#create_sale_form .sale-buttons-container').before(productElement1);
            document.querySelector('#create_sale_form .sale-buttons-container').before(productElement2);
            document.querySelector('#create_sale_form .sale-buttons-container').before(productElement3);
        });
    </script>
</body>
</html>